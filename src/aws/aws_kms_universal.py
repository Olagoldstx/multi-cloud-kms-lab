#!/usr/bin/env python3
import base64
import sys

print("ğŸ” AWS KMS UNIVERSAL DEMO")
print("=" * 40)

def check_boto3():
    """Check if boto3 is available"""
    try:
        import boto3
        return boto3
    except ImportError:
        print("âŒ boto3 not available")
        print("ğŸ’¡ Try these solutions:")
        print("   1. Activate virtual environment: source kms-env/bin/activate")
        print("   2. Install in venv: pip3 install boto3")
        print("   3. Use system package: sudo apt install python3-boto3")
        return None

def demonstrate_aws_concepts():
    """Demonstrate AWS KMS concepts regardless of installation"""
    print("\nğŸ“ AWS KMS CORE CONCEPTS")
    print("=" * 30)
    
    print("1. ğŸ”‘ KEY MANAGEMENT")
    print("   â€¢ Customer Master Keys (CMK)")
    print("   â€¢ Automatic key rotation")
    print("   â€¢ Key policies and IAM integration")
    
    print("\n2. ğŸ” ENCRYPTION WORKFLOW")
    print("   â€¢ Direct encryption for small data (<4KB)")
    print("   â€¢ Envelope encryption for large data")
    print("   â€¢ Data keys generated by KMS")
    
    print("\n3. ğŸŒ INTEGRATION PATTERNS")
    print("   â€¢ AWS Services: S3, EBS, RDS auto-encryption")
    print("   â€¢ Cross-account access")
    print("   â€¢ Multi-region replication")
    
    print("\n4. ğŸ“Š SECURITY & COMPLIANCE")
    print("   â€¢ Hardware Security Modules (HSM)")
    print("   â€¢ CloudTrail logging for all operations")
    print("   â€¢ Compliance certifications (SOC, PCI, HIPAA)")

def simulate_aws_workflow():
    """Simulate the AWS KMS workflow"""
    print("\nğŸ”„ SIMULATED AWS KMS WORKFLOW")
    print("=" * 30)
    
    # Simulate key creation
    key_id = "simulated-kms-key-12345"
    print(f"1. âœ… Key Created: {key_id}")
    
    # Simulate encryption
    plaintext = "Sensitive data for AWS KMS"
    print(f"2. ğŸ“ Plaintext: {plaintext}")
    
    # Simple simulation of encryption
    simulated_cipher = base64.b64encode(f"AWSKMS:{key_id}:{plaintext}".encode()).decode()
    print(f"3. ğŸ”’ Encrypted: {simulated_cipher[:50]}...")
    
    # Simulate decryption
    decoded = base64.b64decode(simulated_cipher).decode()
    if decoded.startswith('AWSKMS:'):
        parts = decoded.split(':')
        decrypted_key = parts[1]
        decrypted_text = ':'.join(parts[2:])
        print(f"4. ğŸ”“ Decrypted with key {decrypted_key}: {decrypted_text}")
    
    # Verify
    if plaintext == decrypted_text:
        print("5. âœ… Verification: Encryption/decryption successful!")

def real_aws_demo():
    """Run real AWS KMS demo if boto3 is available"""
    boto3 = check_boto3()
    if not boto3:
        return False
    
    try:
        print("\nğŸš€ ATTEMPTING REAL AWS KMS SETUP")
        print("-" * 30)
        
        # Initialize AWS KMS client
        kms_client = boto3.client('kms', region_name='us-east-1')
        print("âœ… AWS KMS client initialized")
        
        # Create a KMS key
        response = kms_client.create_key(
            Description='Multi-Cloud KMS Lab Key',
            KeyUsage='ENCRYPT_DECRYPT'
        )
        key_id = response['KeyMetadata']['KeyId']
        print(f"âœ… AWS KMS Key Created: {key_id}")
        
        # Encrypt data
        plaintext = "Secret data for real AWS KMS"
        encrypt_response = kms_client.encrypt(
            KeyId=key_id,
            Plaintext=plaintext.encode()
        )
        ciphertext = base64.b64encode(encrypt_response['CiphertextBlob']).decode()
        print(f"ğŸ”’ Real encryption: {ciphertext[:50]}...")
        
        # Decrypt data
        decrypt_response = kms_client.decrypt(
            CiphertextBlob=base64.b64decode(ciphertext)
        )
        decrypted = decrypt_response['Plaintext'].decode()
        print(f"ğŸ”“ Real decryption: {decrypted}")
        
        if plaintext == decrypted:
            print("ğŸ‰ REAL AWS KMS SUCCESSFUL!")
        
        return True
        
    except Exception as e:
        print(f"âŒ Real AWS KMS failed: {e}")
        print("ğŸ’¡ Check AWS credentials: aws configure")
        return False

if __name__ == "__main__":
    # First demonstrate concepts
    demonstrate_aws_concepts()
    
    # Try real AWS KMS
    real_success = real_aws_demo()
    
    # If real AWS failed, show simulation
    if not real_success:
        simulate_aws_workflow()
    
    print("\n" + "=" * 50)
    print("ğŸ“ AWS KMS LEARNING COMPLETE!")
    print("=" * 50)
    print("You now understand:")
    print("âœ“ AWS KMS architecture and concepts")
    print("âœ“ Key management workflows")
    print("âœ“ Encryption patterns and best practices")
    print("âœ“ Multi-cloud security strategies")
    
    if not real_success:
        print("\nğŸ’¡ To use real AWS KMS:")
        print("   1. Ensure you're in virtual environment: source kms-env/bin/activate")
        print("   2. Install boto3: pip3 install boto3")
        print("   3. Configure AWS: aws configure")
        print("   4. Run this script again")
